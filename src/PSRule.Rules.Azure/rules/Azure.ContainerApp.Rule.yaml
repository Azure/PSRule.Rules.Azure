# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

#
# Rules for Container Apps
#

#region Rules

---
# Synopsis: Ensure insecure inbound traffic is not permitted to the container app.
apiVersion: github.com/microsoft/PSRule/v1
kind: Rule
metadata:
  name: Azure.ContainerApp.Insecure
  ref: AZR-000094
  tags:
    release: 'preview'
    ruleSet: '2022_03'
    Azure.WAF/pillar: 'Security'
  labels:
    Azure.MCSB.v1/control: 'NS-2'
spec:
  with:
  - Azure.ContainerApp.WithIngress
  condition:
    field: 'properties.configuration.ingress.allowInsecure'
    hasDefault: false

---
# Synopsis: Ensure managed identity is used for authentication.
apiVersion: github.com/microsoft/PSRule/v1
kind: Rule
metadata:
  name: Azure.ContainerApp.ManagedIdentity
  ref: AZR-000361
  tags:
    release: GA
    ruleSet: 2023_03
    Azure.WAF/pillar: Security
  labels:
    Azure.MCSB.v1/control: IM-3
spec:
  type:
  - Microsoft.App/containerApps
  condition:
    field: identity.type
    in:
    - SystemAssigned
    - UserAssigned
    - SystemAssigned,UserAssigned

---
# Synopsis: Container Apps should meet naming requirements.
apiVersion: github.com/microsoft/PSRule/v1
kind: Rule
metadata:
  name: Azure.ContainerApp.Name
  ref: AZR-000360
  tags:
    release: GA
    ruleSet: 2023_03
    Azure.WAF/pillar: Operational Excellence
spec:
  type:
    - Microsoft.App/containerApps
  condition:
    allOf:
      - name: '.'
        greaterOrEquals: 2
      - name: '.'
        lessOrEquals: 32
      - name: '.'
        isLower: true
        match: '^([a-z][0-9a-z-]{0,30}[0-9a-z])$'

#endregion Rules

#region Selectors

---
# Synopsis: Get container apps with an ingress configuration.
apiVersion: github.com/microsoft/PSRule/v1
kind: Selector
metadata:
  name: Azure.ContainerApp.WithIngress
spec:
  if:
    allOf:
    - type: '.'
      equals: Microsoft.App/containerApps
    - field: 'properties.configuration.ingress'
      exists: true

#endregion Selectors
