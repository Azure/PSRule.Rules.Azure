---
reviewed: 2024-03-02
severity: Critical
pillar: Security
category: SE:10 Monitoring and threat detection
resource: Microsoft Defender for Cloud
online version: https://azure.github.io/PSRule.Rules.Azure/en/rules/Azure.Defender.Storage.MalwareScan/
---

# Malware Scanning

## SYNOPSIS

Enable Malware Scanning in Microsoft Defender for Storage.

## DESCRIPTION

Microsoft Defender for Storage provides additional security for storage accounts.
One of the features in the Defender for Storage service is malware scanning that is powered by Microsoft Defender Antivirus.

Content uploaded to cloud storage could be malware.
Storage accounts can be an entry point and distribution point for malware in the organization.
To protect organizations from this threat, content in cloud storage must be scanned for malware before it's accessed.

Malware scanning in Defender for Storage helps protect storage accounts from malicious content by,
performing a malware scan on uploaded content in near real time.
When the malware scan identifies a malicious file, detailed Microsoft Defenders for Cloud security alerts are generated.

Malware Scanning in Microsoft Defender for Storage can be enabled at the subscription level.
This ensures all storage accounts in the subscription will be protected, including future ones.

This can be helpful:

- To protect storage accounts from malicious content.
  Especially when content in the storage account is uploaded from untrusted sources.
- To meet compliance standard controls that require on-upload malware scanning for non-compute resources.
  Including standards such as NIST, SWIFT, and UK GOV.

## RECOMMENDATION

Consider using malware scanning in Microsoft Defender for Storage for all storage accounts in the subscription.

## EXAMPLES

### Configure with Azure template

To enable malware scanning in Microsoft Defender for Storage:

- Set the `properties.pricingTier` property to `Standard`.
- Set the `properties.subPlan` property to `DefenderForStorageV2`.
- Configure settings for the `OnUploadMalwareScanning` extension.

For example:

```json
{
  "type": "Microsoft.Security/pricings",
  "apiVersion": "2024-01-01",
  "name": "StorageAccounts",
  "properties": {
    "pricingTier": "Standard",
    "subPlan": "DefenderForStorageV2",
    "extensions": [
      {
        "name": "OnUploadMalwareScanning",
        "isEnabled": "True",
        "additionalExtensionProperties": {
          "CapGBPerMonthPerStorageAccount": "5000"
        }
      },
      {
        "name": "SensitiveDataDiscovery",
        "isEnabled": "True"
      }
    ]
  }
}
```

### Configure with Bicep

To enable malware scanning in Microsoft Defender for Storage:

- Set the `properties.pricingTier` property to `Standard`.
- Set the `properties.subPlan` property to `DefenderForStorageV2`.
- Configure settings for the `OnUploadMalwareScanning` extension.

For example:

```bicep
resource defenderForStorage 'Microsoft.Security/pricings@2024-01-01' = {
  name: 'StorageAccounts'
  properties: {
    pricingTier: 'Standard'
    subPlan: 'DefenderForStorageV2'
    extensions: [
      {
        name: 'OnUploadMalwareScanning'
        isEnabled: 'True'
        additionalExtensionProperties: {
          CapGBPerMonthPerStorageAccount: '5000'
        }
      }
      {
        name: 'SensitiveDataDiscovery'
        isEnabled: 'True'
      }
    ]
  }
}
```

### Configure with Azure Policy

To address this issue at runtime use the following policies:

- [Microsoft Defender for Storage should be enabled](https://github.com/Azure/azure-policy/blob/master/built-in-policies/policyDefinitions/Security%20Center/MDC_Microsoft_Defender_For_Storage_Full_Audit.json)
  `/providers/Microsoft.Authorization/policyDefinitions/640d2586-54d2-465f-877f-9ffc1d2109f4`
- [Configure Microsoft Defender for Storage to be enabled](https://github.com/Azure/azure-policy/blob/master/built-in-policies/policyDefinitions/Security%20Center/MDC_Microsoft_Defender_For_Storage_Full_Deploy.json)
  `/providers/Microsoft.Authorization/policyDefinitions/cfdc5972-75b3-4418-8ae1-7f5c36839390`

## NOTES

Malware scanning is only available in the `DefenderForStorageV2` sub plan for Defender for Storage,
which offers new features that aren't included in the classic plan.

Not all services and blob types within storage accounts are currently supported.
See limitations for more information.

## LINKS

- [SE:10 Monitoring and threat detection](https://learn.microsoft.com/azure/well-architected/security/monitor-threats)
- [What is Microsoft Defender for Cloud?](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-cloud-introduction)
- [Malware Scanning in Defender for Storage](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-storage-malware-scan)
- [Limitations](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-storage-malware-scan#limitations)
- [Setting up response to Malware Scanning](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-storage-malware-scan)
- [Overview of Microsoft Defender for Storage](https://learn.microsoft.com/azure/defender-for-cloud/defender-for-storage-introduction)
- [Enable and configure Microsoft Defender for Storage](https://learn.microsoft.com/azure/storage/common/azure-defender-storage-configure)
- [Quickstart: Enable enhanced security features](https://learn.microsoft.com/azure/defender-for-cloud/enable-enhanced-security)
- [Azure security baseline for Storage](https://learn.microsoft.com/security/benchmark/azure/baselines/storage-security-baseline)
- [DP-2: Monitor anomalies and threats targeting sensitive data](https://learn.microsoft.com/security/benchmark/azure/baselines/storage-security-baseline#dp-2-monitor-anomalies-and-threats-targeting-sensitive-data)
- [LT-1: Enable threat detection capabilities](https://learn.microsoft.com/security/benchmark/azure/baselines/storage-security-baseline#lt-1-enable-threat-detection-capabilities)
- [Azure Policy built-in policy definitions](https://learn.microsoft.com/azure/governance/policy/samples/built-in-policies#security-center)
- [Azure deployment reference](https://learn.microsoft.com/azure/templates/microsoft.security/pricings)
